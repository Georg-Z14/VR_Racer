<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Leaflet f√ºr OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 5px;
            overflow: hidden;
        }

        .video-container video,
        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        #map {
            height: 400px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .email-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .email-form input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .email-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-offline {
            background: #f44336;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>üé• Live-Stream Dashboard</h1>
            <div class="user-info">
                <span>üë§ {{ username }}</span>
                <a href="{{ url_for('logout') }}" class="btn-logout">Abmelden</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Haupt-Grid -->
        <div class="grid">
            <!-- Video-Stream -->
            <div class="card">
                <h2>üìπ Live-Stream</h2>
                <div class="video-container">
                    {% if stream_type == 'webrtc' %}
                    <!-- WebRTC Video -->
                    <video id="videoElement" autoplay playsinline></video>
                    <div class="video-overlay">WebRTC ‚Ä¢ Niedrige Latenz</div>
                    {% else %}
                    <!-- MJPEG Stream -->
                    <img id="streamImage" src="{{ url_for('stream_video') }}" alt="Live-Stream">
                    <div class="video-overlay">MJPEG ‚Ä¢ Live</div>
                    {% endif %}
                </div>
            </div>

            <!-- Fahrtzeit-Info -->
            <div class="card">
                <h2>‚è±Ô∏è Fahrtzeit</h2>
                {% if tracking_stats %}
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value">
                        <span class="status-indicator status-online"></span>
                        Tracking aktiv
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Dauer:</span>
                    <span class="info-value" id="trackingDuration">{{ tracking_stats.duration_formatted }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Distanz:</span>
                    <span class="info-value" id="trackingDistance">{{ tracking_stats.total_distance_km }} km</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Punkte:</span>
                    <span class="info-value" id="trackingPoints">{{ tracking_stats.point_count }}</span>
                </div>
                {% else %}
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value">
                        <span class="status-indicator status-offline"></span>
                        Kein Tracking aktiv
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- GPS-Karte -->
        {% if gps_enabled %}
        <div class="card">
            <h2>üó∫Ô∏è GPS-Route</h2>
            {% if gps_data %}
            <div class="info-item">
                <span class="info-label">Position:</span>
                <span class="info-value">
                    Lat: {{ "%.4f"|format(gps_data.latitude) }},
                    Lon: {{ "%.4f"|format(gps_data.longitude) }}
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Geschwindigkeit:</span>
                <span class="info-value">{{ "%.1f"|format(gps_data.speed) }} km/h</span>
            </div>
            <div class="info-item">
                <span class="info-label">H√∂he:</span>
                <span class="info-value">{{ "%.1f"|format(gps_data.altitude) }} m</span>
            </div>
            {% endif %}
            <div id="map"></div>
        </div>
        {% endif %}

        <!-- Aufnahme per Email anfordern -->
        <div class="card">
            <h2>üìß Aufnahme anfordern</h2>
            <p>Fordern Sie die aktuelle Aufnahme per Email an:</p>
            <form class="email-form" id="requestForm">
                <input
                    type="email"
                    id="emailInput"
                    name="email"
                    placeholder="ihre-email@beispiel.de"
                    required>
                <button type="submit" class="btn-primary">Anfordern</button>
            </form>
            <div id="requestStatus" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        // GPS-Karte initialisieren
        {% if gps_enabled and gps_data %}
        const map = L.map('map').setView([{{ gps_data.latitude }}, {{ gps_data.longitude }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Aktuelle Position markieren
        let currentMarker = L.marker([{{ gps_data.latitude }}, {{ gps_data.longitude }}])
            .addTo(map)
            .bindPopup('Aktuelle Position')
            .openPopup();

        // Route als Linie
        let routeLine = L.polyline([], {color: 'blue', weight: 3}).addTo(map);

        // GPS-Daten aktualisieren (alle 5 Sekunden)
        setInterval(async () => {
            try {
                const response = await fetch('/api/gps/track');
                const data = await response.json();

                if (data.tracking && data.points) {
                    // Aktualisiere Route
                    const latLngs = data.points.map(p => [p.latitude, p.longitude]);
                    routeLine.setLatLngs(latLngs);

                    // Aktualisiere Marker
                    const lastPoint = data.points[data.points.length - 1];
                    currentMarker.setLatLng([lastPoint.latitude, lastPoint.longitude]);

                    // Aktualisiere Statistiken
                    if (data.stats) {
                        document.getElementById('trackingDuration').textContent = data.stats.duration_formatted;
                        document.getElementById('trackingDistance').textContent = data.stats.total_distance_km + ' km';
                        document.getElementById('trackingPoints').textContent = data.stats.point_count;
                    }
                }
            } catch (error) {
                console.error('Fehler beim Aktualisieren der GPS-Daten:', error);
            }
        }, 5000);
        {% endif %}

        // WebRTC-Verbindung (falls aktiviert)
        {% if stream_type == 'webrtc' %}
        const videoElement = document.getElementById('videoElement');
        let peerConnection = null;

        async function startWebRTC() {
            try {
                peerConnection = new RTCPeerConnection({
                    iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
                });

                peerConnection.ontrack = (event) => {
                    videoElement.srcObject = event.streams[0];
                };

                peerConnection.addTransceiver('video', {direction: 'recvonly'});

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const response = await fetch('/webrtc/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sdp: offer.sdp,
                        type: offer.type
                    })
                });

                const answer = await response.json();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));

            } catch (error) {
                console.error('WebRTC-Fehler:', error);
            }
        }

        startWebRTC();

        // Cleanup beim Verlassen
        window.addEventListener('beforeunload', async () => {
            if (peerConnection) {
                peerConnection.close();
                await fetch('/webrtc/close', {method: 'POST'});
            }
        });
        {% endif %}

        // Email-Anforderung
        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            const statusDiv = document.getElementById('requestStatus');

            statusDiv.innerHTML = '<p style="color: #667eea;">üì§ Sende Anfrage...</p>';

            try {
                const formData = new FormData();
                formData.append('email', email);

                const response = await fetch('/user/request-recording', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<p style="color: #4CAF50;">‚úÖ Email wird versendet!</p>';
                    document.getElementById('emailInput').value = '';
                } else {
                    statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå ${data.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<p style="color: #f44336;">‚ùå Fehler beim Senden</p>';
            }
        });
    </script>
</body>
</html>
